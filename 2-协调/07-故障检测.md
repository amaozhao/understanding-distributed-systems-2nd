# 故障检测

当客户端向服务器发送请求时，可能会出现一些问题。在最好的情况下，客户端发送请求并接收响应。但是，如果一段时间后没有回复怎么办？在这种情况下，无法判断服务器是否只是非常慢、崩溃或由于网络问题而无法传递消息（参见图 7.1）。

![](../images/07/7-01.png)


图 7.1：客户端无法判断服务器是否很慢、崩溃或消息由于网络问题而延迟/丢弃。

在最坏的情况下，客户端将永远等待永远不会到达的响应。它所能做的最好的事情是在经过一段时间后对服务器是否不可用做出有根据的猜测。客户端可以配置超时触发，如果在一定时间后没有收到服务器的响应。如果超时触发，客户端会认为服务器不可用并抛出错误或重试请求。

棘手的部分是决定等待超时触发多长时间。如果延迟太短，客户端可能会错误地认为服务器不可用；如果延迟太长，客户端可能会浪费时间等待永远不会到达的响应。总之，不可能构建一个完美的故障检测器。

但是一个进程不需要等待发送消息来发现目的地不可达。它还可以主动尝试使用 ping 或心跳来维护可用进程的列表。

*ping* 是一个进程发送给另一个进程以检查它是否仍然可用的周期性请求。该过程期望在特定时间范围内对 ping 做出响应。如果没有收到响应，则会触发超时，并且认为目标不可用。但是，该进程将继续向它发送 ping，以检测它是否以及何时恢复在线。

*心跳*是一个进程定期发送给另一个进程的消息。如果目标在特定时间范围内没有收到心跳，它会触发超时并认为进程不可用。但是，如果该过程稍后恢复运行并开始发送心跳，它最终将被认为再次可用。

Ping 和心跳通常用于频繁交互的进程，在其中一个不再可访问时需要立即采取行动的情况。在其他情况下，仅在通信时间检测故障就足够了。